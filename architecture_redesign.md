# SC Windows æ¶æ„é‡æ–°è®¾è®¡






## âš ï¸ é‡æ„æ‰§è¡ŒåŸåˆ™ 
  **å…ˆæŸ¥çœ‹åŸå§‹ä»£ç çš„åŠŸèƒ½ç„¶åä»”ç»†æŸ¥çœ‹ç°æœ‰ä»£ç ** 
  **ä»åŸä»£ç çš„mainå‡½æ•°å¯åŠ¨ä¸€æ­¥ä¸€æ­¥å‚è€ƒï¼**
  **ä¸€æ­¥æ­¥ç…§ç€åŸä»£ç çš„é€»è¾‘ ç”¨ç°åœ¨çš„æ¶æ„å®ç°ï¼**
  **ä¸­é€”ä¸æ–­çš„æŸ¥çœ‹è¿˜æœ‰æ²¡æœ‰todoæ²¡æœ‰å®ç°ï¼æœ‰çš„è¯å°±å®ç°ï¼**
  **ä¸€æ­¥æ­¥ç…§ç€åŸä»£ç çš„é€»è¾‘ ç”¨ç°åœ¨çš„æ¶æ„å®ç°ï¼**
  **settingå’Œocrçª—å£éƒ½ç”¨åŸæ–‡ä»¶å°±è¡Œï¼**
### ğŸ¯ æ ¸å¿ƒåŸåˆ™
1. **ä¸¥æ ¼ä¿æŒåŠŸèƒ½ä¸€è‡´æ€§**: æ¯ä¸ªæ­¥éª¤éƒ½è¦ç¡®ä¿åŠŸèƒ½ä¸åŸå§‹é¡¹ç›®å®Œå…¨ä¸€è‡´
2. **é€æ­¥éªŒè¯**: æ¯ä¸ªé˜¶æ®µå®Œæˆåéƒ½è¦éªŒè¯åŠŸèƒ½æ­£å¸¸
3. **ä¿æŒAPIå…¼å®¹**: ç¡®ä¿é‡æ„åçš„æ¥å£ä¸åŸå§‹é¡¹ç›®å…¼å®¹
4. **æ¸è¿›å¼é‡æ„**: ä¸è¿›è¡Œå¤§è§„æ¨¡é‡å†™ï¼Œè€Œæ˜¯é€æ­¥é‡æ„

### ğŸ” é‡åˆ°é”™è¯¯æ—¶çš„å¤„ç†åŸåˆ™
1. **å…ˆæŸ¥çœ‹åŸå§‹æ–‡ä»¶**: å¦‚æœç¼–è¯‘æŠ¥é”™ï¼Œé¦–å…ˆå» `src_backup/` ç›®å½•æŸ¥çœ‹åŸå§‹æ–‡ä»¶çš„å®ç°
2. **å¯¹æ¯”å·®å¼‚**: ä»”ç»†æ¯”å¯¹é‡æ„åçš„ä»£ç ä¸åŸå§‹ä»£ç çš„å·®å¼‚
3. **ä¿æŒåŸæœ‰é€»è¾‘**: å¦‚æœåŸå§‹ä»£ç æ˜¯åŒæ­¥çš„ï¼Œé‡æ„åä¹Ÿå¿…é¡»æ˜¯åŒæ­¥çš„
4. **ä¸è¦å¼ºè¡Œå¼‚æ­¥åŒ–**: ç»å¯¹ä¸è¦å°†åŸæœ¬åŒæ­¥çš„ä»£ç æ”¹ä¸ºå¼‚æ­¥
5. **ä¿æŒæ•°æ®ç»“æ„**: ä¸è¦éšæ„æ”¹å˜åŸæœ‰çš„æ•°æ®ç»“æ„å®šä¹‰
6. **ä¿æŒå‡½æ•°ç­¾å**: å°½é‡ä¿æŒåŸæœ‰å‡½æ•°çš„ç­¾åå’Œè¡Œä¸º

### ğŸ“ å¤‡ä»½ç­–ç•¥
- **åŸå§‹ä»£ç å¤‡ä»½**: æ‰€æœ‰åŸå§‹ä»£ç å·²å¤‡ä»½åˆ° `src_backup/` ç›®å½•
- **éšæ—¶å¯¹æ¯”**: é‡æ„è¿‡ç¨‹ä¸­å¯éšæ—¶å¯¹æ¯”åŸå§‹å®ç°

### ğŸ§ª éªŒè¯ç­–ç•¥
1. **ç¼–è¯‘éªŒè¯**: æ¯ä¸ªé˜¶æ®µéƒ½è¦ç¡®ä¿ä»£ç èƒ½å¤Ÿç¼–è¯‘é€šè¿‡
2. **åŠŸèƒ½éªŒè¯**: è¿è¡Œç¨‹åºéªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
3. **æ€§èƒ½éªŒè¯**: ç¡®ä¿æ€§èƒ½ä¸ä½äºåŸå§‹å®ç°
4. **è§†è§‰éªŒè¯**: ç¡®ä¿UIå’Œæ¸²æŸ“æ•ˆæœä¸åŸå§‹ç‰ˆæœ¬ä¸€è‡´


## é—®é¢˜åˆ†æ

### å½“å‰æ¶æ„çš„é—®é¢˜
1. **å•ä¸€å·¨å‹ç»“æ„ä½“**ï¼š`WindowState` æ‰¿æ‹…äº†æ‰€æœ‰èŒè´£
   - æ¸²æŸ“èµ„æºç®¡ç†ï¼ˆDirect2Dã€DirectWriteã€GDIï¼‰
   - UIçŠ¶æ€ç®¡ç†ï¼ˆå·¥å…·æ ã€é€‰æ‹©åŒºåŸŸã€æ‹–æ‹½çŠ¶æ€ï¼‰
   - ç»˜å›¾åŠŸèƒ½ï¼ˆå…ƒç´ ã€å·¥å…·ã€å†å²è®°å½•ï¼‰
   - è¾“å…¥å¤„ç†ï¼ˆé¼ æ ‡ã€é”®ç›˜ã€æ–‡æœ¬è¾“å…¥ï¼‰
   - ç³»ç»Ÿé›†æˆï¼ˆæ‰˜ç›˜ã€çª—å£æ£€æµ‹ã€OCRï¼‰

2. **è¿åå•ä¸€èŒè´£åŸåˆ™**ï¼šä¸€ä¸ªç»“æ„ä½“è´Ÿè´£å¤ªå¤šä¸ç›¸å…³çš„åŠŸèƒ½
3. **éš¾ä»¥æµ‹è¯•å’Œç»´æŠ¤**ï¼šæ‰€æœ‰åŠŸèƒ½è€¦åˆåœ¨ä¸€èµ·
4. **æ‰©å±•å›°éš¾**ï¼šæ·»åŠ æ–°åŠŸèƒ½éœ€è¦ä¿®æ”¹æ ¸å¿ƒç»“æ„ä½“

### ç°ä»£Rust GUIæ¶æ„åŸåˆ™

åŸºäºIcedç»´æŠ¤è€…çš„å»ºè®®å’Œferrishotç­‰ä¼˜ç§€é¡¹ç›®çš„å®è·µï¼š

1. **æŒ‰é¢†åŸŸåˆ†ç¦»ï¼Œè€ŒéæŒ‰åŠŸèƒ½åˆ†ç¦»**
   - âŒ ä¸è¦åˆ›å»ºå•ç‹¬çš„Stateã€Messageã€Updateã€Viewæ¨¡å—
   - âœ… æ¯ä¸ªæ¨¡å—å›´ç»•ä¸€ä¸ªæ ¸å¿ƒä¸šåŠ¡é¢†åŸŸ

2. **ä¿æŒæ¨¡å—å†…èšæ€§**
   - ç›¸å…³çš„çŠ¶æ€ã€æ¶ˆæ¯ã€å¤„ç†é€»è¾‘åº”è¯¥åœ¨åŒä¸€ä¸ªæ¨¡å—ä¸­
   - æ¯ä¸ªæ¨¡å—éƒ½æ˜¯å®Œæ•´çš„æŠ½è±¡

3. **é€šè¿‡æ¶ˆæ¯è¿›è¡Œæ¨¡å—é—´é€šä¿¡**
   - é¿å…æ¨¡å—é—´ç›´æ¥è®¿é—®çŠ¶æ€
   - ä½¿ç”¨äº‹ä»¶é©±åŠ¨çš„æ¶æ„

## æ–°æ¶æ„è®¾è®¡

### ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ app.rs                  # åº”ç”¨ç¨‹åºåè°ƒå™¨
â”œâ”€â”€ screenshot/             # æˆªå›¾æ ¸å¿ƒåŠŸèƒ½é¢†åŸŸ
â”‚   â”œâ”€â”€ mod.rs             # æ¨¡å—å…¥å£å’Œå…¬å…±API
â”‚   â”œâ”€â”€ capture.rs         # å±å¹•æ•è·å¼•æ“
â”‚   â”œâ”€â”€ selection.rs       # é€‰æ‹©åŒºåŸŸç®¡ç†
â”‚   â””â”€â”€ save.rs            # ä¿å­˜å’Œå¯¼å‡ºåŠŸèƒ½
â”œâ”€â”€ drawing/               # ç»˜å›¾åŠŸèƒ½é¢†åŸŸ
â”‚   â”œâ”€â”€ mod.rs             # æ¨¡å—å…¥å£
â”‚   â”œâ”€â”€ tools.rs           # ç»˜å›¾å·¥å…·ç®¡ç†
â”‚   â”œâ”€â”€ elements.rs        # ç»˜å›¾å…ƒç´ å®šä¹‰
â”‚   â””â”€â”€ history.rs         # æ’¤é”€/é‡åšç³»ç»Ÿ
â”œâ”€â”€ ui/                    # ç”¨æˆ·ç•Œé¢é¢†åŸŸ
â”‚   â”œâ”€â”€ mod.rs             # æ¨¡å—å…¥å£
â”‚   â”œâ”€â”€ toolbar.rs         # å·¥å…·æ ç»„ä»¶
â”‚   â”œâ”€â”€ overlay.rs         # è¦†ç›–å±‚å’Œé«˜äº®
â”‚   â””â”€â”€ dialogs.rs         # å¯¹è¯æ¡†å’Œå¼¹çª—
â”œâ”€â”€ platform/              # å¹³å°ç‰¹å®šä»£ç 
â”‚   â”œâ”€â”€ mod.rs             # å¹³å°æŠ½è±¡trait
â”‚   â”œâ”€â”€ windows/           # Windowså®ç°
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ d2d.rs         # Direct2Dæ¸²æŸ“å™¨
â”‚   â”‚   â”œâ”€â”€ gdi.rs         # GDIæ“ä½œ
â”‚   â”‚   â””â”€â”€ input.rs       # Windowsè¾“å…¥å¤„ç†
â”‚   â””â”€â”€ traits.rs          # æ¸²æŸ“å™¨traitå®šä¹‰
â”œâ”€â”€ system/                # ç³»ç»Ÿé›†æˆé¢†åŸŸ
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ tray.rs            # ç³»ç»Ÿæ‰˜ç›˜
â”‚   â”œâ”€â”€ hotkeys.rs         # å…¨å±€çƒ­é”®
â”‚   â””â”€â”€ window_detection.rs # çª—å£æ£€æµ‹
â”œâ”€â”€ config.rs              # é…ç½®ç®¡ç†
â”œâ”€â”€ message.rs             # å…¨å±€æ¶ˆæ¯å®šä¹‰
â””â”€â”€ lib.rs                 # åº“å…¥å£
```

### æ ¸å¿ƒç»„ä»¶è®¾è®¡

#### 1. åº”ç”¨ç¨‹åºåè°ƒå™¨ (app.rs)

```rust
pub struct App {
    screenshot: ScreenshotManager,
    drawing: DrawingManager,
    ui: UIManager,
    system: SystemManager,
    platform: Box<dyn PlatformRenderer>,
}

impl App {
    pub fn handle_message(&mut self, message: Message) -> Vec<Command> {
        match message {
            Message::Screenshot(msg) => {
                self.screenshot.handle_message(msg)
            }
            Message::Drawing(msg) => {
                self.drawing.handle_message(msg)
            }
            Message::UI(msg) => {
                self.ui.handle_message(msg)
            }
            Message::System(msg) => {
                self.system.handle_message(msg)
            }
        }
    }
    
    pub fn render(&mut self) -> Result<(), RenderError> {
        // åè°ƒå„ä¸ªç»„ä»¶çš„æ¸²æŸ“
        self.platform.begin_frame()?;
        
        // æ¸²æŸ“æˆªå›¾å†…å®¹
        self.screenshot.render(&mut *self.platform)?;
        
        // æ¸²æŸ“ç»˜å›¾å…ƒç´ 
        self.drawing.render(&mut *self.platform)?;
        
        // æ¸²æŸ“UIè¦†ç›–å±‚
        self.ui.render(&mut *self.platform)?;
        
        self.platform.end_frame()?;
        Ok(())
    }
}
```

#### 2. æˆªå›¾ç®¡ç†å™¨ (screenshot/mod.rs)

```rust
pub struct ScreenshotManager {
    capture_engine: CaptureEngine,
    selection: SelectionState,
    current_screenshot: Option<Screenshot>,
}

#[derive(Debug, Clone)]
pub enum ScreenshotMessage {
    StartCapture,
    UpdateSelection(Rectangle),
    ConfirmSelection,
    CancelCapture,
    SaveToFile(PathBuf),
    CopyToClipboard,
}

impl ScreenshotManager {
    pub fn handle_message(&mut self, message: ScreenshotMessage) -> Vec<Command> {
        match message {
            ScreenshotMessage::StartCapture => {
                self.capture_engine.capture_screen();
                vec![Command::ShowOverlay]
            }
            ScreenshotMessage::UpdateSelection(rect) => {
                self.selection.update(rect);
                vec![Command::RequestRedraw]
            }
            // ... å…¶ä»–æ¶ˆæ¯å¤„ç†
        }
    }
}
```

#### 3. ç»˜å›¾ç®¡ç†å™¨ (drawing/mod.rs)

```rust
pub struct DrawingManager {
    tools: ToolManager,
    elements: Vec<DrawingElement>,
    history: HistoryManager,
    current_tool: DrawingTool,
}

#[derive(Debug, Clone)]
pub enum DrawingMessage {
    SelectTool(DrawingTool),
    StartDrawing(Point),
    UpdateDrawing(Point),
    FinishDrawing,
    Undo,
    Redo,
    DeleteElement(ElementId),
}

impl DrawingManager {
    pub fn handle_message(&mut self, message: DrawingMessage) -> Vec<Command> {
        match message {
            DrawingMessage::SelectTool(tool) => {
                self.current_tool = tool;
                vec![Command::UpdateToolbar]
            }
            DrawingMessage::Undo => {
                if let Some(state) = self.history.undo() {
                    self.elements = state.elements;
                    vec![Command::RequestRedraw]
                } else {
                    vec![]
                }
            }
            // ... å…¶ä»–æ¶ˆæ¯å¤„ç†
        }
    }
}
```

#### 4. UIç®¡ç†å™¨ (ui/mod.rs)

```rust
pub struct UIManager {
    toolbar: Toolbar,
    overlay: OverlayState,
    dialogs: DialogManager,
}

#[derive(Debug, Clone)]
pub enum UIMessage {
    ShowToolbar(Rectangle),
    HideToolbar,
    ToolbarButtonClicked(ToolbarButton),
    ShowDialog(DialogType),
    CloseDialog,
}

impl UIManager {
    pub fn handle_message(&mut self, message: UIMessage) -> Vec<Command> {
        match message {
            UIMessage::ToolbarButtonClicked(button) => {
                match button {
                    ToolbarButton::Save => vec![Command::ShowSaveDialog],
                    ToolbarButton::Copy => vec![Command::CopyToClipboard],
                    ToolbarButton::Rectangle => vec![Command::SelectDrawingTool(DrawingTool::Rectangle)],
                    // ... å…¶ä»–æŒ‰é’®
                }
            }
            // ... å…¶ä»–æ¶ˆæ¯å¤„ç†
        }
    }
}
```

### å¹³å°æŠ½è±¡å±‚

#### æ¸²æŸ“å™¨trait (platform/traits.rs)

```rust
pub trait PlatformRenderer {
    type Error;
    
    fn begin_frame(&mut self) -> Result<(), Self::Error>;
    fn end_frame(&mut self) -> Result<(), Self::Error>;
    
    fn clear(&mut self, color: Color) -> Result<(), Self::Error>;
    fn draw_image(&mut self, image: &Image, rect: Rectangle) -> Result<(), Self::Error>;
    fn draw_rectangle(&mut self, rect: Rectangle, style: &Style) -> Result<(), Self::Error>;
    fn draw_text(&mut self, text: &str, position: Point, style: &TextStyle) -> Result<(), Self::Error>;
    
    fn create_brush(&mut self, color: Color) -> Result<BrushId, Self::Error>;
    fn create_font(&mut self, desc: &FontDesc) -> Result<FontId, Self::Error>;
}
```

#### Windowså®ç° (platform/windows/d2d.rs)

```rust
pub struct Direct2DRenderer {
    factory: ID2D1Factory,
    render_target: ID2D1HwndRenderTarget,
    brushes: HashMap<BrushId, ID2D1SolidColorBrush>,
    fonts: HashMap<FontId, IDWriteTextFormat>,
}

impl PlatformRenderer for Direct2DRenderer {
    type Error = D2DError;
    
    fn begin_frame(&mut self) -> Result<(), Self::Error> {
        unsafe {
            self.render_target.BeginDraw();
        }
        Ok(())
    }
    
    fn draw_rectangle(&mut self, rect: Rectangle, style: &Style) -> Result<(), Self::Error> {
        let d2d_rect = D2D_RECT_F {
            left: rect.x,
            top: rect.y,
            right: rect.x + rect.width,
            bottom: rect.y + rect.height,
        };
        
        if let Some(brush) = self.brushes.get(&style.brush_id) {
            unsafe {
                self.render_target.DrawRectangle(&d2d_rect, brush, style.stroke_width, None);
            }
        }
        Ok(())
    }
    
    // ... å…¶ä»–æ–¹æ³•å®ç°
}
```

### æ¶ˆæ¯ç³»ç»Ÿ

#### å…¨å±€æ¶ˆæ¯å®šä¹‰ (message.rs)

```rust
#[derive(Debug, Clone)]
pub enum Message {
    Screenshot(ScreenshotMessage),
    Drawing(DrawingMessage),
    UI(UIMessage),
    System(SystemMessage),
}

#[derive(Debug, Clone)]
pub enum Command {
    RequestRedraw,
    ShowOverlay,
    HideOverlay,
    UpdateToolbar,
    ShowSaveDialog,
    CopyToClipboard,
    SelectDrawingTool(DrawingTool),
    Quit,
}
```

## å®æ–½è®¡åˆ’

### é˜¶æ®µ1ï¼šåˆ›å»ºæ–°çš„æ¨¡å—ç»“æ„
1. åˆ›å»ºæ–°çš„ç›®å½•ç»“æ„
2. å®šä¹‰å„ä¸ªç®¡ç†å™¨çš„åŸºæœ¬æ¥å£
3. å®ç°æ¶ˆæ¯ç³»ç»Ÿ

### é˜¶æ®µ2ï¼šé€æ­¥è¿ç§»åŠŸèƒ½
1. å…ˆè¿ç§»æˆªå›¾åŠŸèƒ½åˆ°ScreenshotManager
2. ç„¶åè¿ç§»ç»˜å›¾åŠŸèƒ½åˆ°DrawingManager
3. æœ€åè¿ç§»UIåŠŸèƒ½åˆ°UIManager

### é˜¶æ®µ3ï¼šå¹³å°æŠ½è±¡
1. æå–æ¸²æŸ“å™¨trait
2. å®ç°Direct2Dæ¸²æŸ“å™¨
3. éš”ç¦»Windowsç‰¹å®šä»£ç 

### é˜¶æ®µ4ï¼šæ¸…ç†å’Œä¼˜åŒ–
1. ç§»é™¤åŸæœ‰çš„WindowState
2. ä¼˜åŒ–ç»„ä»¶é—´é€šä¿¡
3. å®Œå–„æµ‹è¯•å’Œæ–‡æ¡£

## ä¼˜åŠ¿

1. **æ¨¡å—åŒ–**ï¼šæ¯ä¸ªç»„ä»¶èŒè´£æ˜ç¡®ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
2. **å¯æµ‹è¯•æ€§**ï¼šå„ä¸ªç»„ä»¶å¯ä»¥ç‹¬ç«‹æµ‹è¯•
3. **å¯æ‰©å±•æ€§**ï¼šæ·»åŠ æ–°åŠŸèƒ½ä¸ä¼šå½±å“ç°æœ‰ç»„ä»¶
4. **å¹³å°æ— å…³**ï¼šæ ¸å¿ƒé€»è¾‘ä¸å¹³å°å®ç°åˆ†ç¦»
5. **ç°ä»£åŒ–**ï¼šç¬¦åˆRustç¤¾åŒºçš„æœ€ä½³å®è·µ

è¿™ä¸ªæ¶æ„è®¾è®¡æ—¢è§£å†³äº†å½“å‰"æŠŠæ‰€æœ‰ä¸œè¥¿éƒ½æ”¾åœ¨WindowStateé‡Œé¢"çš„é—®é¢˜ï¼Œåˆéµå¾ªäº†ç°ä»£Rust GUIå¼€å‘çš„æœ€ä½³å®è·µã€‚
